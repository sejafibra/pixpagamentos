<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Recebimentos PIX - Seja Fibra</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .sidebar {
            min-height: 100vh;
            background-color: #343a40;
            color: white;
        }
        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.75);
        }
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            color: white;
            background-color: rgba(255, 255, 255, 0.1);
        }
        .main-content {
            padding: 20px;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .verified {
            background-color: #d4edda !important;
        }
        .table-responsive {
            max-height: 500px;
            overflow-y: auto;
        }
        .login-container {
            max-width: 400px;
            margin: 0 auto;
            margin-top: 100px;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="container login-container">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">Login - Gestão PIX</h4>
            </div>
            <div class="card-body">
                <form id="login-form">
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Senha</label>
                        <input type="password" class="form-control" id="password" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Entrar</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Main App (hidden until login) -->
    <div id="app-container" class="container-fluid" style="display: none;">
        <div class="row">
            <div class="col-md-2 sidebar p-0">
                <div class="p-3">
                    <h5 class="text-center mb-4">Seja Fibra</h5>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" id="nav-upload">
                                <i class="bi bi-upload me-2"></i>Upload CSV
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="nav-geral">
                                <i class="bi bi-list-check me-2"></i>Registro Geral
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="nav-meses">
                                <i class="bi bi-calendar-month me-2"></i>Por Mês
                            </a>
                        </li>
                        <li class="nav-item mt-4">
                            <a class="nav-link text-danger" href="#" id="nav-logout">
                                <i class="bi bi-box-arrow-left me-2"></i>Sair
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="col-md-10 main-content">
                <div id="upload-section">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">Upload de Relatório CSV</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="csv-file" class="form-label">Selecione o arquivo CSV</label>
                                <input class="form-control" type="file" id="csv-file" accept=".csv">
                            </div>
                            <button id="process-csv" class="btn btn-primary">Processar CSV</button>
                            
                            <div class="mt-4" id="processed-data-container" style="display: none;">
                                <h6>Dados Processados</h6>
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover" id="processed-table">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Descrição</th>
                                                <th>Referência 1</th>
                                                <th>Referência 2</th>
                                                <th>Nome do Cliente</th>
                                                <th>Data</th>
                                                <th>Valor</th>
                                            </tr>
                                        </thead>
                                        <tbody id="processed-data">
                                            <!-- Processed data will appear here -->
                                        </tbody>
                                    </table>
                                </div>
                                <button id="register-data" class="btn btn-success mt-3">Registrar no Firebase</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="geral-section" style="display: none;">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">Registro Geral</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover" id="geral-table">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Descrição</th>
                                            <th>Referência 1</th>
                                            <th>Referência 2</th>
                                            <th>Nome do Cliente</th>
                                            <th>Data</th>
                                            <th>Valor</th>
                                        </tr>
                                    </thead>
                                    <tbody id="geral-data">
                                        <!-- Data from Firebase will appear here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="meses-section" style="display: none;">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Recebimentos por Mês</h5>
                                <div>
                                    <select class="form-select form-select-sm" id="month-select" style="width: 150px;">
                                        <!-- Months will be populated here -->
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="table-responsive">
                                        <table class="table table-bordered table-hover" id="month-table">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>ID da Transação</th>
                                                    <th>Nome do Pagador</th>
                                                    <th>Data</th>
                                                    <th>Valor (R$)</th>
                                                    <th>Ação</th>
                                                </tr>
                                            </thead>
                                            <tbody id="month-data">
                                                <!-- Monthly data will appear here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header bg-secondary text-white">
                                            <h6 class="mb-0">Resumo Diário</h6>
                                        </div>
                                        <div class="card-body">
                                            <table class="table table-bordered" id="daily-summary">
                                                <thead>
                                                    <tr>
                                                        <th>Data</th>
                                                        <th>Total (R$)</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="daily-summary-data">
                                                    <!-- Daily summary will appear here -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase and other JS -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBy3lW3KdZZjXuY6Mf2noJyt3hqAwcGak8",
            authDomain: "pix-recebimento.firebaseapp.com",
            projectId: "pix-recebimento",
            storageBucket: "pix-recebimento.appspot.com",
            messagingSenderId: "244724309479",
            appId: "1:244724309479:web:c4d9a25c2213325535b142",
            databaseURL: "https://pix-recebimento-default-rtdb.firebaseio.com/"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // DOM Elements
        const loginScreen = document.getElementById('login-screen');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const logoutBtn = document.getElementById('nav-logout');
        
        // Navigation
        const navUpload = document.getElementById('nav-upload');
        const navGeral = document.getElementById('nav-geral');
        const navMeses = document.getElementById('nav-meses');
        
        // Sections
        const uploadSection = document.getElementById('upload-section');
        const geralSection = document.getElementById('geral-section');
        const mesesSection = document.getElementById('meses-section');
        
        // Upload CSV elements
        const csvFileInput = document.getElementById('csv-file');
        const processCsvBtn = document.getElementById('process-csv');
        const processedDataContainer = document.getElementById('processed-data-container');
        const processedDataTable = document.getElementById('processed-data');
        const registerDataBtn = document.getElementById('register-data');
        
        // Geral section elements
        const geralDataTable = document.getElementById('geral-data');
        
        // Meses section elements
        const monthSelect = document.getElementById('month-select');
        const monthDataTable = document.getElementById('month-data');
        const dailySummaryTable = document.getElementById('daily-summary-data');

        // Global variables
        let processedData = [];
        let currentUser = null;

        // Auth state listener
        auth.onAuthStateChanged(user => {
            if (user) {
                const email = user.email;
                if (email === 'financeiro@sejafibra.net' || email === 'bioranss@gmail.com') {
                    currentUser = user;
                    loginScreen.style.display = 'none';
                    appContainer.style.display = 'block';
                    showSection('upload');
                    loadGeralData();
                    populateMonthSelect();
                } else {
                    auth.signOut();
                    alert('Acesso não autorizado. Use um email válido.');
                }
            } else {
                loginScreen.style.display = 'block';
                appContainer.style.display = 'none';
            }
        });

        // Login form
        loginForm.addEventListener('submit', e => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            auth.signInWithEmailAndPassword(email, password)
                .catch(error => {
                    alert('Erro no login: ' + error.message);
                });
        });

        // Logout
        logoutBtn.addEventListener('click', () => {
            auth.signOut();
        });

        // Navigation
        navUpload.addEventListener('click', () => showSection('upload'));
        navGeral.addEventListener('click', () => {
            showSection('geral');
            loadGeralData();
        });
        navMeses.addEventListener('click', () => {
            showSection('meses');
            populateMonthSelect();
        });

        function showSection(section) {
            uploadSection.style.display = 'none';
            geralSection.style.display = 'none';
            mesesSection.style.display = 'none';
            
            if (section === 'upload') uploadSection.style.display = 'block';
            if (section === 'geral') geralSection.style.display = 'block';
            if (section === 'meses') mesesSection.style.display = 'block';
        }

        // Process CSV
        processCsvBtn.addEventListener('click', () => {
            const file = csvFileInput.files[0];
            if (!file) {
                alert('Selecione um arquivo CSV primeiro.');
                return;
            }
            
            Papa.parse(file, {
                complete: function(results) {
                    processCsvData(results.data);
                },
                header: false,
                skipEmptyLines: true
            });
        });

        function processCsvData(data) {
            processedData = [];
            
            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                const descricao = row[0] || ''; // Coluna A: Descrição
                const referencia1 = row[1] || ''; // Coluna B: Referência 1
                const referencia2 = row[2] || ''; // Coluna C: Referência 2
                const nomeCliente = row[3] || ''; // Coluna D: Nome do cliente (Creditado)
                const dataStr = row[6] || ''; // Coluna G: Data
                let valor = row[7] || ''; // Coluna H: Valor
                
                // Verificar se a descrição começa com "Recebimento"
                if (descricao.trim().toLowerCase().includes('recebimento')) {
                    // Processar data (remover hora se existir)
                    let dataFormatada = dataStr.split(' ')[0];
                    
                    // Processar valor (remover zeros à esquerda se for string)
                    if (typeof valor === 'string') {
                        valor = valor.replace(/^0+/, '');
                    }
                    
                    processedData.push({
                        descricao,
                        referencia1,
                        referencia2,
                        nomeCliente,
                        data: dataFormatada,
                        valor
                    });
                }
            }
            
            displayProcessedData();
        }

        function displayProcessedData() {
            processedDataTable.innerHTML = '';
            
            if (processedData.length === 0) {
                processedDataContainer.style.display = 'none';
                alert('Nenhum dado de recebimento PIX encontrado no arquivo.');
                return;
            }
            
            processedData.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.descricao}</td>
                    <td>${item.referencia1}</td>
                    <td>${item.referencia2}</td>
                    <td>${item.nomeCliente}</td>
                    <td>${item.data}</td>
                    <td>${item.valor}</td>
                `;
                processedDataTable.appendChild(row);
            });
            
            processedDataContainer.style.display = 'block';
        }

        // Register data to Firebase
        registerDataBtn.addEventListener('click', () => {
            if (processedData.length === 0) {
                alert('Nenhum dado para registrar.');
                return;
            }
            
            const geralRef = database.ref('geral');
            const updates = {};
            
            processedData.forEach(item => {
                const newKey = geralRef.push().key;
                updates[`geral/${newKey}`] = {
                    descricao: item.descricao,
                    referencia1: item.referencia1,
                    referencia2: item.referencia2,
                    nomeCliente: item.nomeCliente,
                    data: item.data,
                    valor: item.valor,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };
                
                // Also add to monthly collection
                const dateParts = item.data.split('/');
                const monthYear = `${dateParts[1]}-${dateParts[2]}`;
                updates[`meses/${monthYear}/${newKey}`] = {
                    idTransacao: item.referencia1,
                    nomePagador: item.nomeCliente,
                    data: item.data,
                    valor: item.valor,
                    valorFormatado: parseFloat(item.valor).toFixed(2).replace('.', ','),
                    verificado: false
                };
            });
            
            database.ref().update(updates)
                .then(() => {
                    alert('Dados registrados com sucesso!');
                    processedData = [];
                    processedDataContainer.style.display = 'none';
                    csvFileInput.value = '';
                })
                .catch(error => {
                    alert('Erro ao registrar dados: ' + error.message);
                });
        });

        // Load Geral data
        function loadGeralData() {
            database.ref('geral').orderByChild('timestamp').once('value')
                .then(snapshot => {
                    geralDataTable.innerHTML = '';
                    
                    if (!snapshot.exists()) {
                        geralDataTable.innerHTML = '<tr><td colspan="6" class="text-center">Nenhum dado encontrado</td></tr>';
                        return;
                    }
                    
                    snapshot.forEach(childSnapshot => {
                        const item = childSnapshot.val();
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${item.descricao}</td>
                            <td>${item.referencia1}</td>
                            <td>${item.referencia2}</td>
                            <td>${item.nomeCliente}</td>
                            <td>${item.data}</td>
                            <td>R$ ${parseFloat(item.valor).toFixed(2).replace('.', ',')}</td>
                        `;
                        geralDataTable.appendChild(row);
                    });
                })
                .catch(error => {
                    alert('Erro ao carregar dados gerais: ' + error.message);
                });
        }

        // Populate month select
        function populateMonthSelect() {
            database.ref('meses').once('value')
                .then(snapshot => {
                    monthSelect.innerHTML = '<option value="">Selecione um mês</option>';
                    
                    if (!snapshot.exists()) {
                        return;
                    }
                    
                    const months = [];
                    snapshot.forEach(childSnapshot => {
                        months.push(childSnapshot.key);
                    });
                    
                    // Sort months (MM-YYYY) in descending order
                    months.sort((a, b) => {
                        const [aMonth, aYear] = a.split('-').map(Number);
                        const [bMonth, bYear] = b.split('-').map(Number);
                        return bYear - aYear || bMonth - aMonth;
                    });
                    
                    months.forEach(month => {
                        const [monthNum, year] = month.split('-');
                        const monthName = new Date(year, monthNum - 1, 1).toLocaleString('pt-BR', { month: 'long' });
                        const option = document.createElement('option');
                        option.value = month;
                        option.textContent = `${monthName.charAt(0).toUpperCase() + monthName.slice(1)} ${year}`;
                        monthSelect.appendChild(option);
                    });
                });
        }

        // Load month data when selected
        monthSelect.addEventListener('change', () => {
            const selectedMonth = monthSelect.value;
            if (!selectedMonth) return;
            
            loadMonthData(selectedMonth);
        });

        function loadMonthData(monthYear) {
            database.ref(`meses/${monthYear}`).orderByChild('data').once('value')
                .then(snapshot => {
                    monthDataTable.innerHTML = '';
                    dailySummaryTable.innerHTML = '';
                    
                    if (!snapshot.exists()) {
                        monthDataTable.innerHTML = '<tr><td colspan="5" class="text-center">Nenhum dado encontrado para este mês</td></tr>';
                        return;
                    }
                    
                    const dailyTotals = {};
                    
                    snapshot.forEach(childSnapshot => {
                        const item = childSnapshot.val();
                        const row = document.createElement('tr');
                        if (item.verificado) {
                            row.classList.add('verified');
                        }
                        
                        row.innerHTML = `
                            <td>${item.idTransacao}</td>
                            <td>${item.nomePagador}</td>
                            <td>${item.data}</td>
                            <td>R$ ${item.valorFormatado}</td>
                            <td>
                                <button class="btn btn-sm ${item.verificado ? 'btn-success' : 'btn-outline-secondary'} verify-btn" 
                                        data-id="${childSnapshot.key}" data-month="${monthYear}">
                                    <i class="bi bi-check-lg"></i> ${item.verificado ? 'Conferido' : 'Conferir'}
                                </button>
                            </td>
                        `;
                        monthDataTable.appendChild(row);
                        
                        // Calculate daily totals
                        if (!dailyTotals[item.data]) {
                            dailyTotals[item.data] = 0;
                        }
                        dailyTotals[item.data] += parseFloat(item.valor);
                    });
                    
                    // Populate daily summary
                    Object.keys(dailyTotals).sort().forEach(date => {
                        const total = dailyTotals[date].toFixed(2).replace('.', ',');
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${date}</td>
                            <td>R$ ${total}</td>
                        `;
                        dailySummaryTable.appendChild(row);
                    });
                    
                    // Add event listeners to verify buttons
                    document.querySelectorAll('.verify-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const id = this.getAttribute('data-id');
                            const month = this.getAttribute('data-month');
                            const isVerified = this.classList.contains('btn-success');
                            toggleVerification(id, month, !isVerified);
                        });
                    });
                });
        }

        function toggleVerification(id, monthYear, verify) {
            database.ref(`meses/${monthYear}/${id}/verificado`).set(verify)
                .then(() => {
                    loadMonthData(monthYear);
                })
                .catch(error => {
                    alert('Erro ao atualizar status: ' + error.message);
                });
        }
    </script>
</body>
</html>
