<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Recebimentos PIX - Seja Fibra</title>
    <link rel="icon" href="https://raw.githubusercontent.com/sejafibra/pixpagamentos/refs/heads/main/faviconsf.ico" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- SheetJS (XLS/XLSX) já incluído -->
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>

    <style>
        body {
            background-color: #f8f9fa;
        }
        .sidebar {
            min-height: 100vh;
            background-color: #343a40;
            color: white;
        }
        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.75);
        }
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            color: white;
            background-color: rgba(255, 255, 255, 0.1);
        }
        .main-content {
            padding: 20px;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .verified {
            background-color: #d4edda !important;
        }
        .login-container {
            max-width: 400px;
            margin: 0 auto;
            margin-top: 100px;
        }
        .action-buttons {
            white-space: nowrap;
        }
        .btn-export {
            background-color: #0d6efd;
            color: white;
        }
        .btn-export:hover {
            background-color: #0b5ed7;
            color: white;
        }
        /* estilos para tabela de diferenças */
        .ixc { background:#e8f6ff; }
        .fran { background:#fff7e6; }
        #log { margin-top:10px; color:#666; font-size:13px; }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="container login-container">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">Login - Gestão PIX</h4>
            </div>
            <div class="card-body">
                <form id="login-form">
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Senha</label>
                        <input type="password" class="form-control" id="password" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Entrar</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Main App (hidden until login) -->
    <div id="app-container" class="container-fluid" style="display: none;">
        <div class="row">
            <div class="col-md-2 sidebar p-0">
                <div class="p-3">
                    <h5 class="text-center mb-4">Seja Fibra</h5>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" id="nav-upload">
                                <i class="bi bi-upload me-2"></i>Upload CSV
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="nav-geral">
                                <i class="bi bi-list-check me-2"></i>Registro Geral
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="nav-meses">
                                <i class="bi bi-calendar-month me-2"></i>Por Mês
                            </a>
                        </li>

                        <!-- NOVO: Diferença Banco no sidebar -->
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="nav-diferenca">
                                <i class="bi bi-shuffle me-2"></i>Diferença Banco
                            </a>
                        </li>

                        <li class="nav-item mt-4">
                            <a class="nav-link text-danger" href="#" id="nav-logout">
                                <i class="bi bi-box-arrow-left me-2"></i>Sair
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="col-md-10 main-content">
                <!-- Seção Upload (original) -->
                <div id="upload-section">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">Upload de Relatório CSV</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="csv-file" class="form-label">Selecione o arquivo CSV</label>
                                <input class="form-control" type="file" id="csv-file" accept=".csv">
                            </div>
                            <button id="process-csv" class="btn btn-primary">Processar CSV</button>
                            
                            <div class="mt-4" id="processed-data-container" style="display: none;">
                                <h6>Dados Processados</h6>
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover" id="processed-table">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Descrição</th>
                                                <th>Referência 1</th>
                                                <th>Referência 2</th>
                                                <th>Data</th>
                                                <th>Valor</th>
                                            </tr>
                                        </thead>
                                        <tbody id="processed-data">
                                            <!-- Processed data will appear here -->
                                        </tbody>
                                    </table>
                                </div>
                                <button id="register-data" class="btn btn-success mt-3">Registrar no Firebase</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Seção Geral (original) -->
                <div id="geral-section" style="display: none;">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">Registro Geral</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover" id="geral-table">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Descrição</th>
                                            <th>Referência 1</th>
                                            <th>Referência 2</th>
                                            <th>Data</th>
                                            <th>Valor</th>
                                        </tr>
                                    </thead>
                                    <tbody id="geral-data">
                                        <!-- Data from Firebase will appear here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Seção Meses (original) -->
                <div id="meses-section" style="display: none;">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Recebimentos por Mês</h5>
                                <div>
                                    <select class="form-select form-select-sm" id="month-select" style="width: 150px;">
                                        <!-- Months will be populated here -->
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered" id="daily-summary">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Data</th>
                                            <th>Total (R$)</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="daily-summary-data">
                                        <!-- Daily summary will appear here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- NOVA SEÇÃO: Diferença Banco (UI id's compatíveis com seu código isolado) -->
                <div id="diferenca-section" style="display: none;">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">Comparar IXC × Francesinha</h5>
                        </div>
                        <div class="card-body">
                            <div>
                                <label><strong>Upload arquivo IXC (Relatório de Contas a Receber > Contas a Receber):</strong>
                                  <input id="ixcFile" type="file" accept=".csv,.txt,.xls,.xlsx" class="form-control">
                                </label>
                            </div>

                            <div class="mt-3">
                                <label><strong>Upload arquivo Sicredi (Francesinha):</strong>
                                  <input id="franFile" type="file" accept=".csv,.txt,.xls,.xlsx" class="form-control">
                                </label>
                            </div>

                            <div class="mt-3">
                                <button id="btnCompare" class="btn btn-primary">ANALISAR</button>
                                <button id="btnExport" class="btn btn-outline-secondary ms-2" disabled>Exportar Diferenças (CSV)</button>
                            </div>

                            <div id="log" class="mt-3"></div>

                            <table id="resultTable" aria-live="polite" class="table table-bordered table-hover mt-3">
                              <thead>
                                <tr><th>Origem</th><th>Cliente / Pagador</th><th>Valor</th></tr>
                              </thead>
                              <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <!-- FIM seções -->

            </div>
        </div>
    </div>

    <!-- Bibliotecas JS externas (a parte 2 trará o script inline com toda a lógica) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>

    <!-- A seguir (parte 2): script inline com Firebase config, funções existentes e o parser/compare robusto que você enviou -->
    <script>
        // -------------------------
        // Configuração Firebase
        // -------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyBy3lW3KdZZjXuY6Mf2noJyt3hqAwcGak8",
            authDomain: "pix-recebimento.firebaseapp.com",
            projectId: "pix-recebimento",
            storageBucket: "pix-recebimento.appspot.com",
            messagingSenderId: "244724309479",
            appId: "1:244724309479:web:c4d9a25c2213325535b142",
            databaseURL: "https://pix-recebimento-default-rtdb.firebaseio.com/"
        };

        // Inicializa o Firebase compat (como no seu HTML original)
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // -------------------------
        // Elementos DOM principais
        // -------------------------
        const loginScreen = document.getElementById('login-screen');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const logoutBtn = document.getElementById('nav-logout');

        const navUpload = document.getElementById('nav-upload');
        const navGeral = document.getElementById('nav-geral');
        const navMeses = document.getElementById('nav-meses');
        const navDiferenca = document.getElementById('nav-diferenca');

        const uploadSection = document.getElementById('upload-section');
        const geralSection = document.getElementById('geral-section');
        const mesesSection = document.getElementById('meses-section');
        const diferencaSection = document.getElementById('diferenca-section');

        // Upload CSV (originais)
        const csvFileInput = document.getElementById('csv-file');
        const processCsvBtn = document.getElementById('process-csv');
        const processedDataContainer = document.getElementById('processed-data-container');
        const processedDataTable = document.getElementById('processed-data');
        const registerDataBtn = document.getElementById('register-data');

        // Geral / Meses (originais)
        const geralDataTable = document.getElementById('geral-data');
        const monthSelect = document.getElementById('month-select');
        const dailySummaryTable = document.getElementById('daily-summary-data');

        // Diferença Banco (IDs compatíveis com o seu HTML isolado)
        const ixcFileInput = document.getElementById('ixcFile');
        const franFileInput = document.getElementById('franFile');
        const btnCompare = document.getElementById('btnCompare');
        const btnExport = document.getElementById('btnExport');
        const logEl = document.getElementById('log');
        const resultTbody = document.querySelector('#resultTable tbody');

        // Variáveis globais
        let processedData = [];
        let currentUser = null;
        let monthlyDataCache = {}; // cache para meses
        window.__lastComparison = window.__lastComparison || [];

        // -------------------------
        // Auth listener (mesma lógica do HTML original)
        // -------------------------
        auth.onAuthStateChanged(user => {
            if (user) {
                const email = user.email;
                if (email === 'financeiro@sejafibra.net' || email === 'bioranss@gmail.com') {
                    currentUser = user;
                    loginScreen.style.display = 'none';
                    appContainer.style.display = 'block';
                    showSection('upload');
                    loadGeralData();
                    populateMonthSelect();
                } else {
                    auth.signOut();
                    alert('Acesso não autorizado. Use um email válido.');
                }
            } else {
                loginScreen.style.display = 'block';
                appContainer.style.display = 'none';
            }
        });

        // Login
        loginForm.addEventListener('submit', e => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            auth.signInWithEmailAndPassword(email, password)
                .catch(error => alert('Erro no login: ' + error.message));
        });

        // Logout
        logoutBtn.addEventListener('click', () => auth.signOut());

        // Navegação
        navUpload.addEventListener('click', () => showSection('upload'));
        navGeral.addEventListener('click', () => { showSection('geral'); loadGeralData(); });
        navMeses.addEventListener('click', () => { showSection('meses'); populateMonthSelect(); });
        navDiferenca.addEventListener('click', () => showSection('diferenca'));

        function showSection(section) {
            uploadSection.style.display = 'none';
            geralSection.style.display = 'none';
            mesesSection.style.display = 'none';
            diferencaSection.style.display = 'none';
            navUpload.classList.remove('active');
            navGeral.classList.remove('active');
            navMeses.classList.remove('active');
            navDiferenca.classList.remove('active');

            if (section === 'upload') { uploadSection.style.display = 'block'; navUpload.classList.add('active'); }
            if (section === 'geral') { geralSection.style.display = 'block'; navGeral.classList.add('active'); }
            if (section === 'meses') { mesesSection.style.display = 'block'; navMeses.classList.add('active'); }
            if (section === 'diferenca') { diferencaSection.style.display = 'block'; navDiferenca.classList.add('active'); }
        }

        // -------------------------
        // Funções originais: process CSV e registrar (mantidas)
        // -------------------------
        processCsvBtn.addEventListener('click', () => {
            const file = csvFileInput.files[0];
            if (!file) { alert('Selecione um arquivo CSV primeiro.'); return; }
            Papa.parse(file, {
                complete: function(results) {
                    processCsvData(results.data);
                },
                header: false,
                skipEmptyLines: true
            });
        });

        function processCsvData(data) {
            processedData = [];
            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                const descricao = row[0] || '';
                const referencia1 = row[1] || '';
                const referencia2 = row[2] || '';
                const dataStr = row[6] || '';
                let valor = row[7] || '';
                if (descricao.trim().toLowerCase().includes('recebimento')) {
                    let dataFormatada = dataStr.split(' ')[0];
                    if (typeof valor === 'string') valor = valor.replace(/^0+/, '');
                    processedData.push({ descricao, referencia1, referencia2, data: dataFormatada, valor });
                }
            }
            displayProcessedData();
        }

        function displayProcessedData() {
            processedDataTable.innerHTML = '';
            if (processedData.length === 0) {
                processedDataContainer.style.display = 'none';
                alert('Nenhum dado de recebimento PIX encontrado no arquivo.');
                return;
            }
            processedData.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${item.descricao}</td><td>${item.referencia1}</td><td>${item.referencia2}</td><td>${item.data}</td><td>${item.valor}</td>`;
                processedDataTable.appendChild(row);
            });
            processedDataContainer.style.display = 'block';
        }

        registerDataBtn.addEventListener('click', async () => {
            if (processedData.length === 0) { alert('Nenhum dado para registrar.'); return; }
            try {
                const geralRef = database.ref('geral');
                const snapshot = await geralRef.once('value');
                const existingIds = new Set();
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => existingIds.add(childSnapshot.val().referencia1));
                }
                const updates = {};
                const newItems = [];
                processedData.forEach(item => { if (!existingIds.has(item.referencia1)) newItems.push(item); });
                if (newItems.length === 0) { alert('Todos os itens já existem no sistema. Nada foi registrado.'); return; }

                newItems.forEach(item => {
                    const newKey = geralRef.push().key;
                    updates[`geral/${newKey}`] = {
                        descricao: item.descricao,
                        referencia1: item.referencia1,
                        referencia2: item.referencia2,
                        data: item.data,
                        valor: item.valor,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    };
                    const dateParts = item.data.split('/');
                    const monthYear = `${dateParts[1]}-${dateParts[2]}`;
                    updates[`meses/${monthYear}/${newKey}`] = {
                        idTransacao: item.referencia1,
                        descricao: item.descricao,
                        referencia2: item.referencia2,
                        data: item.data,
                        valor: item.valor,
                        valorFormatado: parseFloat(item.valor).toFixed(2).replace('.', ','),
                        verificado: false
                    };
                });

                await database.ref().update(updates);
                alert(`${newItems.length} itens registrados com sucesso! ${processedData.length - newItems.length} itens duplicados foram ignorados.`);
                processedData = [];
                processedDataContainer.style.display = 'none';
                csvFileInput.value = '';
            } catch (err) {
                alert('Erro ao registrar dados: ' + err.message);
            }
        });

        // -------------------------
        // Funções originais: carregar gerais/meses
        // -------------------------
        function loadGeralData() {
            database.ref('geral').orderByChild('timestamp').once('value')
                .then(snapshot => {
                    geralDataTable.innerHTML = '';
                    if (!snapshot.exists()) {
                        geralDataTable.innerHTML = '<tr><td colspan="5" class="text-center">Nenhum dado encontrado</td></tr>';
                        return;
                    }
                    snapshot.forEach(childSnapshot => {
                        const item = childSnapshot.val();
                        const row = document.createElement('tr');
                        row.innerHTML = `<td>${item.descricao}</td><td>${item.referencia1}</td><td>${item.referencia2}</td><td>${item.data}</td><td>R$ ${parseFloat(item.valor).toFixed(2).replace('.', ',')}</td>`;
                        geralDataTable.appendChild(row);
                    });
                })
                .catch(err => alert('Erro ao carregar dados gerais: ' + err.message));
        }

        function populateMonthSelect() {
            database.ref('meses').once('value')
                .then(snapshot => {
                    monthSelect.innerHTML = '<option value="">Selecione um mês</option>';
                    
                    if (!snapshot.exists()) {
                        return;
                    }
                    
                    const months = [];
                    snapshot.forEach(childSnapshot => {
                        months.push(childSnapshot.key);
                    });
                    
                    // Sort months (MM-YYYY) in descending order
                    months.sort((a, b) => {
                        const [aMonth, aYear] = a.split('-').map(Number);
                        const [bMonth, bYear] = b.split('-').map(Number);
                        return bYear - aYear || bMonth - aMonth;
                    });
                    
                    months.forEach(month => {
                        const [monthNum, year] = month.split('-');
                        const monthName = new Date(year, monthNum - 1, 1).toLocaleString('pt-BR', { month: 'long' });
                        const option = document.createElement('option');
                        option.value = month;
                        option.textContent = `${monthName.charAt(0).toUpperCase() + monthName.slice(1)} ${year}`;
                        monthSelect.appendChild(option);
                    });
                });
        }

        // Load month data when selected
        monthSelect.addEventListener('change', () => {
            const selectedMonth = monthSelect.value;
            if (!selectedMonth) return;
            
            loadMonthData(selectedMonth);
        });

        function loadMonthData(monthYear) {
    database.ref(`meses/${monthYear}`).orderByChild('data').once('value')
        .then(snapshot => {
            dailySummaryTable.innerHTML = '';
            monthlyDataCache = {};
            if (!snapshot.exists()) {
                dailySummaryTable.innerHTML = '<tr><td colspan="3" class="text-center">Nenhum dado encontrado para este mês</td></tr>';
                return;
            }
            const dailyTotals = {};
            const dailyVerified = {};
            const dailyItems = {};
            snapshot.forEach(childSnapshot => {
                const item = childSnapshot.val();
                if (!dailyTotals[item.data]) {
                    dailyTotals[item.data] = 0;
                    dailyVerified[item.data] = true;
                    dailyItems[item.data] = [];
                }
                dailyTotals[item.data] += parseFloat(item.valor);
                dailyItems[item.data].push(item);
                if (!item.verificado) dailyVerified[item.data] = false;
            });
            monthlyDataCache[monthYear] = dailyItems;
            Object.keys(dailyTotals).sort().forEach(date => {
                const total = dailyTotals[date].toFixed(2).replace('.', ',');
                const isVerified = dailyVerified[date];
                const row = document.createElement('tr');
                if (isVerified) row.classList.add('verified');
                row.innerHTML = `<td>${date}</td><td>R$ ${total}</td><td class="action-buttons">
                    <button class="btn btn-sm ${isVerified ? 'btn-success' : 'btn-outline-secondary'} verify-btn me-2" data-date="${date}" data-month="${monthYear}">
                        <i class="bi bi-check-lg"></i> ${isVerified ? 'Conferido' : 'Conferir'}
                    </button>
                    <button class="btn btn-sm btn-danger delete-btn me-2" data-date="${date}" data-month="${monthYear}">
                        <i class="bi bi-trash"></i> Excluir
                    </button>
                    <button class="btn btn-sm btn-export export-btn" data-date="${date}" data-month="${monthYear}">
                        <i class="bi bi-download"></i> Exportar
                    </button>
                </td>`;
                dailySummaryTable.appendChild(row);
            });

            setTimeout(() => {
                document.querySelectorAll('.verify-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const date = this.getAttribute('data-date'); 
                        const month = this.getAttribute('data-month');
                        const isVerified = this.classList.contains('btn-success');
                        toggleDailyVerification(date, month, !isVerified);
                    });
                });
                
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        if (!confirm('Tem certeza que deseja excluir TODOS os registros deste dia? Esta ação não pode ser desfeita.')) return;
                        const date = this.getAttribute('data-date'); 
                        const month = this.getAttribute('data-month');
                        deleteDailyData(date, month);
                    });
                });
                
                document.querySelectorAll('.export-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const date = this.getAttribute('data-date'); 
                        const month = this.getAttribute('data-month');
                        exportDailyData(date, month);
                    });
                });
            }, 100);
        }); // ← ESTE é o único fechamento necessário do .then()
} // ← ESTE é o fechamento da função loadMonthData

function toggleDailyVerification(date, monthYear, verify) {
    const monthRef = database.ref(`meses/${monthYear}`);
    monthRef.once('value')
        .then(snapshot => {
            const updates = {};
            snapshot.forEach(childSnapshot => {
                const item = childSnapshot.val();
                if (item.data === date) {
                    updates[`meses/${monthYear}/${childSnapshot.key}/verificado`] = verify;
                }
            });
            return database.ref().update(updates);
        })
        .then(() => loadMonthData(monthYear))
        .catch(err => alert('Erro ao atualizar status: ' + err.message));
}

        function deleteDailyData(date, monthYear) {
            database.ref(`meses/${monthYear}`).orderByChild('data').equalTo(date).once('value')
                .then(snapshot => {
                    const updates = {};
                    snapshot.forEach(childSnapshot => { updates[`meses/${monthYear}/${childSnapshot.key}`] = null; updates[`geral/${childSnapshot.key}`] = null; });
                    return database.ref().update(updates);
                })
                .then(() => { alert('Dados do dia excluídos com sucesso!'); loadMonthData(monthYear); loadGeralData(); })
                .catch(err => alert('Erro ao excluir dados: ' + err.message));
        }

        function exportDailyData(date, monthYear) {
            if (!monthlyDataCache[monthYear] || !monthlyDataCache[monthYear][date]) { alert('Dados não encontrados para exportação.'); return; }
            const dailyData = monthlyDataCache[monthYear][date];
            const exportData = dailyData.map(item => ({
                'ID da Transação': item.idTransacao,
                'Descrição': item.descricao,
                'Referência 2': item.referencia2,
                'Data': item.data,
                'Valor (R$)': parseFloat(item.valor).toFixed(2)
            }));
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Recebimentos");
            XLSX.writeFile(wb, `Recebimentos_PIX_${date.replace(/\//g, '-')}.xlsx`);
        }

        // -------------------------
        // PARSER / COMPARADOR ROBUSTO (o seu código isolado, adaptado)
        // -------------------------
        function trimOrEmpty(v){ return v===undefined||v===null? "": String(v).trim(); }
        function onlyDigits(s){ return String(s||"").replace(/\D/g,""); }

        function parseNumberString(s){
          if(s===undefined || s===null) return NaN;
          s = String(s).replace(/\u00A0/g,"").replace(/\s+/g,"").replace(/R\$/ig,"").trim();
          if(s === "") return NaN;
          if(s.indexOf('.')>-1 && s.indexOf(',')>-1){
            s = s.replace(/\./g,'').replace(',', '.');
          } else if(s.indexOf(',')>-1){
            s = s.replace(',', '.');
          }
          s = s.replace(/[^\d\.\-]/g,'');
          const n = parseFloat(s);
          return isNaN(n) ? NaN : n;
        }

        function fmtBR(n){
          if(n===null || n===undefined || isNaN(n)) return "";
          return Number(n).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function readFileToRows(file){
          return new Promise((resolve, reject) => {
            const fName = file.name.toLowerCase();
            const reader = new FileReader();

            // XLS / XLSX -> usar SheetJS e extrair primeira aba como array de arrays
            if(fName.endsWith('.xls') || fName.endsWith('.xlsx')){
              reader.onload = (e) => {
                try {
                  const data = new Uint8Array(e.target.result);
                  const wb = XLSX.read(data, { type: 'array' });
                  const sheet = wb.Sheets[wb.SheetNames[0]];
                  const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: false });
                  resolve(rows);
                } catch(err){
                  reject(err);
                }
              };
              reader.onerror = (err)=>reject(err);
              reader.readAsArrayBuffer(file);
              return;
            }

            // CSV/TXT -> ler como texto e detectar delimitador (tab, ;, ,)
            reader.onload = (e) => {
              try {
                const txt = e.target.result.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
                const lines = txt.split('\n');
                // encontrar primeira linha não vazia para detectar delimitador
                let sampleLine = "";
                for(let L of lines){ if(L.trim()){ sampleLine = L; break; } }
                let delim = ',';
                if(sampleLine.indexOf('\t') > -1) delim = '\t';
                else if(sampleLine.indexOf(';') > -1) delim = ';';
                else delim = ',';

                const rows = lines.map(line => line.split(delim).map(c => c === undefined ? "" : c.trim()));
                resolve(rows);
              } catch(err){ reject(err); }
            };
            reader.onerror = err => reject(err);
            reader.readAsText(file, 'utf-8');
          });
        }

        function findHeaderIndex(rows, mustContainPatterns, minMatches=2){
          for(let i=0;i<rows.length;i++){
            const row = rows[i].map(c=>String(c||""));
            let matches = 0;
            for(const pat of mustContainPatterns){
              if(row.some(cell => pat.test(String(cell)))) matches++;
            }
            if(matches >= minMatches) return i;
          }
          return -1;
        }

        function findColumnIndex(headerRow, patterns){
          const header = headerRow.map(c=>String(c||""));
          for(let i=0;i<header.length;i++){
            const cell = header[i];
            for(const pat of patterns){
              if(pat.test(cell)) return i;
            }
          }
          return -1;
        }

        function parseIXCRows(rows){
          const headerIdx = findHeaderIndex(rows, [ /ID\s*Rec/i, /Cliente/i ], 2);
          if (headerIdx === -1) return {error: 'Cabeçalho IXC não encontrado (procuro por "ID Rec" e "Cliente").', data: []};

          const headerRow = rows[headerIdx];
          const idxIdRec = findColumnIndex(headerRow, [/ID\s*Rec/i, /ID\s*Receb/i, /ID\s*conta/i]);
          const idxCliente = findColumnIndex(headerRow, [/Cliente/i, /Nome/i]);
          const idxValBaixa = findColumnIndex(headerRow, [/Val.*Baixa/i, /Val\.*\s*Baixa/i, /Val.*Baixa/i]);
          const idxValor = findColumnIndex(headerRow, [/^(Valor|Val\.)$/i, /Valor/i, /Val\./i]);

          if(idxIdRec < 0 || idxCliente < 0) {
            return { error: 'Não foi possível mapear colunas essenciais no IXC (ID Rec ou Cliente).', data: [] };
          }

          const out = [];
          for(let r = headerIdx + 1; r < rows.length; r++){
            const row = rows[r];
            if(!row) continue;
            const rawId = trimOrEmpty(row[idxIdRec]);
            const id = onlyDigits(rawId);
            if(!id) continue;
            const cliente = trimOrEmpty(row[idxCliente]);
            const rawValBaixa = idxValBaixa >= 0 ? trimOrEmpty(row[idxValBaixa]) : (idxValor>=0 ? trimOrEmpty(row[idxValor]) : "");
            const num = parseNumberString(rawValBaixa);
            out.push({
              id,
              cliente,
              valNum: isNaN(num) ? null : num,
              valRaw: rawValBaixa
            });
          }
          return { error: null, data: out };
        }

        function parseFrancesinhaRows(rows){
          const headerIdx = findHeaderIndex(rows, [ /Seu\s*°|Seu\s*N|^Seu\b|Seu\s*Nr|Seu\s*N[o°]?/i, /Pagador/i ], 2);
          if(headerIdx === -1) {
            const movIdx = rows.findIndex(r => (r||[]).some(c => /Movimentos do dia/i.test(String(c))));
            if(movIdx >= 0 && movIdx + 1 < rows.length) {
              for(let tryIdx = movIdx + 1; tryIdx <= movIdx + 4 && tryIdx < rows.length; tryIdx++){
                if((rows[tryIdx]||[]).some(c => /Seu/i.test(String(c))) && (rows[tryIdx]||[]).some(c => /Pagador/i.test(String(c)))){
                  const headerRow = rows[tryIdx];
                  const idxSeu = findColumnIndex(headerRow, [/Seu\s*°|Seu\s*N|^Seu\b|Seu\s*Nr|Seu\s*N[o°]?/i]);
                  const idxPag = findColumnIndex(headerRow, [/Pagador/i]);
                  const idxVal = findColumnIndex(headerRow, [/Vlr.*Mov|Vlr.*Movimento|Valor$/i, /Valor/i, /Vlr/i]);
                  if(idxSeu>=0 && idxPag>=0) {
                    const out = [];
                    for(let r = tryIdx + 1; r < rows.length; r++){
                      const row = rows[r];
                      if(!row) continue;
                      const rawSeu = trimOrEmpty(row[idxSeu]);
                      const seu = onlyDigits(rawSeu);
                      if(!seu) continue;
                      const pagador = trimOrEmpty(row[idxPag]);
                      const rawVal = idxVal>=0 ? trimOrEmpty(row[idxVal]) : "";
                      const num = parseNumberString(rawVal);
                      out.push({ id: seu, pagador, valNum: isNaN(num) ? null : num, valRaw: rawVal });
                    }
                    return { error: null, data: out };
                  }
                }
              }
            }
            return { error: 'Cabeçalho Francesinha não encontrado (procuro por "Seu N°" e "Pagador").', data: [] };
          }

          const headerRow = rows[headerIdx];
          const idxSeu = findColumnIndex(headerRow, [/Seu\s*°|Seu\s*N|^Seu\b|Seu\s*Nr|Seu\s*N[o°]?/i]);
          const idxPag = findColumnIndex(headerRow, [/Pagador/i]);
          const idxVal = findColumnIndex(headerRow, [/Vlr.*Mov|Vlr.*Movimento|Valor$/i, /Valor/i, /Vlr/i]);

          if(idxSeu < 0 || idxPag < 0){
            return { error: 'Não foi possível mapear colunas essenciais na Francesinha (Seu N° ou Pagador).', data: [] };
          }

          const out = [];
          for(let r = headerIdx + 1; r < rows.length; r++){
            const row = rows[r];
            if(!row) continue;
            const rawSeu = trimOrEmpty(row[idxSeu]);
            const seu = onlyDigits(rawSeu);
            if(!seu) continue;
            const pagador = trimOrEmpty(row[idxPag]);
            const rawVal = idxVal >= 0 ? trimOrEmpty(row[idxVal]) : "";
            const num = parseNumberString(rawVal);
            out.push({ id: seu, pagador, valNum: isNaN(num) ? null : num, valRaw: rawVal });
          }
          return { error: null, data: out };
        }

        // -------------------------
        // Lógica do botão "ANALISAR" (Comparar)
        // -------------------------
        btnCompare.addEventListener('click', async () => {
          logEl.textContent = "Processando...";
          resultTbody.innerHTML = "";
          btnExport.disabled = true;
          const ixcFile = ixcFileInput.files[0];
          const franFile = franFileInput.files[0];
          if(!ixcFile || !franFile){ alert("Selecione ambos os arquivos (IXC e Francesinha)."); logEl.textContent = ""; return; }

          try {
            const [rowsIXC, rowsFran] = await Promise.all([ readFileToRows(ixcFile), readFileToRows(franFile) ]);
            const parsedIXC = parseIXCRows(rowsIXC);
            if(parsedIXC.error){ alert(parsedIXC.error); logEl.textContent = parsedIXC.error; return; }
            const parsedFran = parseFrancesinhaRows(rowsFran);
            if(parsedFran.error){ alert(parsedFran.error); logEl.textContent = parsedFran.error; return; }

            const mapIXC = {}; parsedIXC.data.forEach(r => { mapIXC[r.id] = r; });
            const mapFran = {}; parsedFran.data.forEach(r => { mapFran[r.id] = r; });

            const result = [];

            for(const id in mapIXC){
              if(!mapFran[id]){
                const row = mapIXC[id];
                result.push({
                  origem: 'IXC',
                  nome: row.cliente || '',
                  valorNum: row.valNum,
                  valorStr: row.valNum !== null ? fmtBR(row.valNum) : (row.valRaw || '')
                });
              }
            }
            for(const id in mapFran){
              if(!mapIXC[id]){
                const row = mapFran[id];
                result.push({
                  origem: 'Francesinha',
                  nome: row.pagador || '',
                  valorNum: row.valNum,
                  valorStr: row.valNum !== null ? fmtBR(row.valNum) : (row.valRaw || '')
                });
              }
            }

            resultTbody.innerHTML = "";
            if(result.length === 0){
              resultTbody.innerHTML = '<tr><td colspan="3">Nenhuma diferença encontrada</td></tr>';
              logEl.textContent = 'Nenhuma diferença encontrada.';
              window.__lastComparison = result;
              btnExport.disabled = true;
            } else {
              for(const r of result){
                const tr = document.createElement('tr');
                tr.className = r.origem === 'IXC' ? 'ixc' : 'fran';
                const cellOrig = `<td>${r.origem}</td>`;
                const cellName = `<td>${r.nome}</td>`;
                const cellVal = `<td>${r.valorStr}</td>`;
                tr.innerHTML = cellOrig + cellName + cellVal;
                resultTbody.appendChild(tr);
              }
              logEl.textContent = `Encontradas ${result.length} diferença(s).`;
              window.__lastComparison = result;
              btnExport.disabled = false;
            }

          } catch(err) {
            console.error(err);
            alert("Erro ao processar arquivos. Veja console do navegador para detalhes.");
            logEl.textContent = "Erro: " + (err && err.message ? err.message : String(err));
          }
        });

        // -------------------------
        // Export CSV (botão Exportar)
        // -------------------------
        btnExport.addEventListener('click', () => {
          const rows = window.__lastComparison || [];
          if(!rows.length){ alert("Sem resultados para exportar."); return; }
          let csv = 'Origem;Cliente/Pagador;Valor\n';
          for(const r of rows){
            const name = String(r.nome || '').replace(/"/g,'""');
            csv += `${r.origem};"${name}";${r.valorStr}\n`;
          }
          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'diferencas.csv';
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        });

        // -------------------------
        // Fim do script - marca pronto
        // -------------------------
    </script>
</body>
</html>
